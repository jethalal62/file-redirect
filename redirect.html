<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"> <!-- Disable caching -->
    <title>Movie Redirect</title>
</head>
<body>
    <a id="streamButton">Loading...</a>

    <script type="module">
        // Replace with your Supabase credentials
        const SUPABASE_URL = "https://itrvfwwxjoedvrmhkkvi.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0cnZmd3d4am9lZHZybWhra3ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1NzIwMTYsImV4cCI6MjA1NjE0ODAxNn0.-XZZTiEBhy75cIWo_IpcYFWET7ckSfu0b6l4-ev0S0s";
        
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // Get movie ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('id');
        console.log("Current Movie ID:", movieId); // Debugging

        async function loadMovie() {
            try {
                // Force fresh data with cache-busting
                const { data, error } = await supabase
                    .from('movies')
                    .select('*')
                    .eq('id', movieId)
                    .single()
                    .then(response => {
                        console.log("Supabase Response:", response); // Debug
                        return response;
                    });

                if (data?.streamhg_url) {
                    document.getElementById('streamButton').href = data.streamhg_url + `?t=${Date.now()}`; // Cache-bust
                    console.log("Updated URL:", data.streamhg_url); // Debug
                } else {
                    document.body.innerHTML = `<h1>Movie ${movieId} not found</h1>`;
                }
            } catch (err) {
                console.error("Error:", err);
            }
        }

        // Initial load
        loadMovie();

        // Realtime updates (filtered to current movie)
        const channel = supabase.channel('movie-updates')
            .on('postgres_changes', {
                event: '*',
                schema: 'public',
                table: 'movies',
                filter: `id=eq.${movieId}` // Critical fix: only listen for THIS movie
            }, () => {
                console.log("Realtime update detected!");
                loadMovie();
            })
            .subscribe();

        // Cleanup on page close
        window.addEventListener('beforeunload', () => {
            supabase.removeChannel(channel);
        });
    </script>
</body>
</html>
