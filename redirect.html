<script>
    // Initialize Supabase with your credentials
    const SUPABASE_URL = 'https://itrvfwwxjoedvrmhkkvi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0cnZmd3d4am9lZHZybWhra3ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1NzIwMTYsImV4cCI6MjA1NjE0ODAxNn0.-XZZTiEBhy75cIWo_IpcYFWET7ckSfu0b6l4-ev0S0s';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Add timeout for redirect fallback
    let redirectTimer;

    async function performRedirect() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            const movieId = urlParams.get('id');
            const action = urlParams.get('action');

            if (!movieId || !action) {
                throw new Error('Missing required parameters: id and action must be specified');
            }

            const { data: movie, error } = await supabase
                .from('movies')
                .select('*')
                .eq('id', movieId)
                .single();

            if (error) throw error;
            if (!movie) throw new Error('Requested content could not be found');

            const validActions = {
                telegram: movie.telegram_url,
                download: movie.cloud_download_url,
                stream: movie.streamhg_url
            };

            const targetUrl = validActions[action];
            
            if (!targetUrl) {
                throw new Error('Invalid action type specified');
            }

            if (!/^https?:\/\//i.test(targetUrl)) {
                throw new Error(`The ${action} link is not properly formatted`);
            }

            // Set timeout fallback (5 seconds)
            redirectTimer = setTimeout(() => {
                showError('Redirect is taking too long. Please try again.');
            }, 5000);

            window.location.replace(targetUrl);

        } catch (error) {
            clearTimeout(redirectTimer);
            showError(error.message);
            console.error('Redirect Error:', error);
        }
    }

    // Start the redirect process
    performRedirect();
</script>
