<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Redirecting...</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="loader" id="loader"></div>
  <script>
    document.addEventListener("DOMContentLoaded", async function () {
      const urlParams = new URLSearchParams(window.location.search);
      const movieId = urlParams.get('id');
      const action = urlParams.get('action');
      console.log("Movie ID from URL:", movieId);
      console.log("Action from URL:", action);

      if (!movieId || !action) {
        document.body.innerHTML = "Missing required parameters!";
        return;
      }

      // Initialize Supabase client (update these with your actual details if needed)
      const SUPABASE_URL = 'https://itrvfwwxjoedvrmhkkvi.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0cnZmd3d4am9lZHZybWhra3ZpIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0MDU3MjAxNiwiZXhwIjoyMDU2MTQ4MDE2fQ.0qZQ0XMntEClYPNWsE876eh9i56d3D3HdGTNIMJfhgI';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        headers: {
          'Accept': 'application/json',
          'apikey': SUPABASE_KEY
        }
      });

      try {
        // Fetch the movie details from Supabase
        const { data: movie, error } = await supabase
          .from('movies')
          .select('*')
          .eq('id', movieId)
          .single();
        if (error || !movie) {
          throw error || new Error("Movie not found");
        }
        console.log("Movie data from Supabase:", movie);

        // Map actions to URL columns
        const actionUrls = {
          telegram: movie.telegram_url,
          download: movie.cloud_download_url,
          stream: movie.streamhg_url
        };

        const targetUrl = actionUrls[action];
        if (!targetUrl) {
          throw new Error("Invalid action specified");
        }
        // Append timestamp to bypass cache
        window.location.replace(targetUrl + "?t=" + new Date().getTime());
      } catch (error) {
        console.error("Error in redirect:", error);
        document.body.innerHTML = `<p>Error: ${error.message}</p>`;
      }
    });
  </script>
</body>
</html>
