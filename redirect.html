<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieHub - Fixed Version</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner {
            animation: rotate 2s linear infinite;
            color: #ff4757;
            font-size: 3rem;
        }

        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }

        /* Error message styling */
        .error-message {
            color: #ff4757;
            padding: 1rem;
            border: 2px solid #ff4757;
            border-radius: 5px;
            margin: 2rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <i class="fas fa-spinner spinner"></i>
    </div>

    <div class="container">
        <div class="movie-header">
            <img src="https://via.placeholder.com/300x450?text=Loading+Poster" 
                 class="movie-poster" 
                 id="moviePoster">
            
            <div class="movie-info">
                <h1 class="movie-title" id="movieTitle">Loading Movie...</h1>
                <div class="movie-meta">
                    <span id="movieGenre">• Genre •</span>
                    <span id="movieYear">• Year •</span>
                </div>
            </div>
        </div>

        <div class="options-grid">
            <div class="option-card">
                <i class="fab fa-telegram-plane option-icon"></i>
                <h3>Telegram Download</h3>
                <a class="btn telegram-btn" id="telegramBtn" target="_blank">
                    <i class="fab fa-telegram-plane"></i>
                    Get via Telegram
                </a>
            </div>

            <div class="option-card">
                <i class="fas fa-cloud-download-alt option-icon"></i>
                <h3>Direct Download</h3>
                <a class="btn cloud-btn" id="cloudBtn" target="_blank">
                    <i class="fas fa-download"></i>
                    Download Now
                </a>
            </div>

            <div class="option-card">
                <i class="fas fa-play-circle option-icon"></i>
                <h3>Instant Streaming</h3>
                <a class="btn stream-btn" id="streamBtn" target="_blank">
                    <i class="fas fa-play"></i>
                    Watch Now
                </a>
            </div>
        </div>

        <div class="error-message" id="errorContainer"></div>
    </div>

    <script>
        // ======== SUPABASE CONFIGURATION ======== //
        const SUPABASE_URL = 'https://oroekqfmpofvmchjwidy.supabase.co'; // Replace with your URL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yb2VrcWZtcG9mdm1jaGp3aWR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1NzEyNTgsImV4cCI6MjA1NjE0NzI1OH0.ModeDQiBayq9sUQSGVy33tydUXDgbyYxKN3A9En0tmE'; // Replace with your key
        // ======================================== //

        // Initialize Supabase client FIRST
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Error handling function
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = `
                <h3>⚠️ Error</h3>
                <p>${message}</p>
                <button onclick="location.reload()" 
                        style="margin-top: 1rem; padding: 0.8rem 1.5rem;
                        background: #ff4757; color: white; border: none;
                        border-radius: 5px; cursor: pointer;">
                    Try Again
                </button>
            `;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Get movie ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const movieId = urlParams.get('id');

                if (!movieId) throw new Error('Missing movie ID in URL');

                // Fetch movie data using maybeSingle() for better error handling
                const { data: movie, error } = await supabase
                    .from('movies')
                    .select('*')
                    .eq('id', movieId)
                    .maybeSingle();

                if (error) throw error;
                if (!movie) throw new Error('Movie not found in database');

                // Validate URLs
                const requiredUrls = [
                    movie.telegram_url,
                    movie.cloud_download_url,
                    movie.streamhg_url
                ];

                if (requiredUrls.some(url => !url?.startsWith('http'))) {
                    throw new Error('Invalid URL format in database');
                }

                // Update UI
                document.getElementById('movieTitle').textContent = movie.title;
                document.getElementById('movieGenre').textContent = movie.genre;
                document.getElementById('movieYear').textContent = movie.release_year;
                document.getElementById('moviePoster').src = movie.poster_url;

                // Set button URLs
                document.getElementById('telegramBtn').href = movie.telegram_url;
                document.getElementById('cloudBtn').href = movie.cloud_download_url;
                document.getElementById('streamBtn').href = movie.streamhg_url;

                // Hide loading spinner
                document.getElementById('loading').style.display = 'none';

            } catch (error) {
                showError(error.message);
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html>
