<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieHub - Watch & Download</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Previous CSS remains unchanged */
        .error-container {
            text-align: center;
            padding: 2rem;
            background: rgba(255,71,87,0.1);
            border-radius: 10px;
            margin: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Your existing HTML content -->
    </div>

    <script>
        // ======== CONFIGURATION ======== //
        const SUPABASE_URL = 'https://itrvfwwxjoedvrmhkkvi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0cnZmd3d4am9lZHZybWhra3ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA1NzIwMTYsImV4cCI6MjA1NjE0ODAxNn0.-XZZTiEBhy75cIWo_IpcYFWET7ckSfu0b6l4-ev0S0s';
        // =============================== //

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const movieId = urlParams.get('id');

                // 1. Validate URL Parameter
                if (!movieId || movieId.trim() === '') {
                    throw new Error('Invalid URL - Missing movie ID');
                }

                // 2. Fetch Data Without .single()
                const { data: movies, error } = await supabaseClient
                    .from('movies')
                    .select('*')
                    .eq('id', movieId);

                // 3. Handle Supabase Errors
                if (error) throw error;

                // 4. Validate Results
                if (!movies || movies.length === 0) {
                    throw new Error('Movie not found in database');
                }

                if (movies.length > 1) {
                    throw new Error('Database error: Duplicate movie IDs found');
                }

                // 5. Process Valid Data
                const movie = movies[0];
                
                // Update UI elements
                document.getElementById('movieTitle').textContent = movie.title;
                document.getElementById('moviePoster').src = movie.poster_url;
                document.getElementById('telegramBtn').href = movie.telegram_url;
                document.getElementById('cloudBtn').href = movie.cloud_download_url;
                document.getElementById('streamBtn').href = movie.streamhg_url;

            } catch (error) {
                // Create error container
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-container';
                errorDiv.innerHTML = `
                    <h2 style="color: #ff4757;">⚠️ ${error.message}</h2>
                    <p style="margin: 1rem 0;">Possible fixes:</p>
                    <ul style="text-align: left; margin: 1rem auto; max-width: 300px;">
                        ${error.message.includes('Duplicate') ? 
                            '<li>Contact admin to fix database</li>' : 
                            '<li>Check URL for ?id= parameter</li>'+
                            '<li>Verify movie exists</li>'}
                    </ul>
                    <div style="margin-top: 1.5rem;">
                        <button onclick="location.reload()" 
                            style="margin-right: 1rem; padding: 0.8rem 1.5rem;">
                            Reload
                        </button>
                        <a href="/" style="text-decoration: none;">
                            <button style="padding: 0.8rem 1.5rem;">
                                Go Home
                            </button>
                        </a>
                    </div>
                `;

                // Clear existing content
                document.body.innerHTML = '';
                document.body.appendChild(errorDiv);
            }
        });
    </script>
</body>
</html>
